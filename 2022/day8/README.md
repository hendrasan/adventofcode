A nice puzzle. My code is quite verbose but I think it's easy to understand.

Definitely can use better algorithm to minimize the amount of checking.
